<template>
  <div>
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">
          Original Purchaser Registration for {{ dealership }}
          <span class ="alignright" v-if="readOnly">
            <b-tooltip label="Delete OPR" position="is-bottom">
              <b-button @click="toDelete(id)" type="is-info" v-if="isNRB"><b-icon icon="delete" ></b-icon></b-button>
            </b-tooltip>
            &nbsp;
            <b-tooltip label="Download PDF" position="is-bottom">
              <b-button @click="toPDF(id)" type="is-info"><b-icon icon="file-pdf-box" ></b-icon></b-button>
            </b-tooltip>
          </span>
        </h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-6-tablet is-7-desktop">
        <b-field label="Company/Agency">
          <b-input v-model="form.agency" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-5-desktop" v-if="!isNRB">
      </div>
      <div class="column is-6-tablet is-5-desktop" v-if="isNRB">
        <b-field label="Contract">
          <b-input v-model="form.contract" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-5-desktop required">
        <b-field label="First Name"
          :type="{'is-danger': $v.form.first_name.$error}"
          :message="{'First Name is Required': $v.form.first_name.$error}"
          v-bind:class="{ 'is-danger': $v.form.first_name.$error }"
        >
          <b-input v-model="form.first_name" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-7-desktop required">
        <b-field label="Last Name"
          :type="{'is-danger': $v.form.last_name.$error}"
          :message="{'Last Name is Required': $v.form.last_name.$error}"
          v-bind:class="{ 'is-danger': $v.form.last_name.$error }"
        >
          <b-input v-model="form.last_name" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Home Phone Number"
          :type="{'is-danger': $v.form.phone_home.$error}"
          :message="{
            'Required if no home phone or email address': !$v.form.phone_home.$required
               && $v.form.phone_home.minLength
               && $v.form.phone_home.$error,
            'Not a valid phone number': !$v.form.phone_home.minLength}"
            v-bind:class="{ 'is-danger': $v.form.phone_home.$error }"
        >
          <b-input v-model="form.phone_home" v-cleave="masks.phoneNumber" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Work Phone Number"
          :type="{'is-danger': $v.form.phone_work.$error}"
          :message="{
            'Required if no work phone or email address': !$v.form.phone_work.$required
               && $v.form.phone_work.minLength
               && $v.form.phone_work.$error,
            'Not a valid phone number': !$v.form.phone_work.minLength}"
            v-bind:class="{ 'is-danger': $v.form.phone_work.$error }"
        >
          <b-input v-model="form.phone_work" v-cleave="masks.phoneNumber" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-6-desktop">
        <b-field label="Email"
          :type="{'is-danger': $v.form.email.$error}"
          :message="{
            'Required if no home or work phone': !$v.form.email.$required
               && $v.form.email.email
               && $v.form.email.$error,
            'Not a valid email address': !$v.form.email.email}"
            v-bind:class="{ 'is-danger': $v.form.email.$error }"
        >
          <b-input v-model="form.email" :readonly="readOnly"></b-input>
        </b-field>
      </div>
    </div>

    <!-- STREET ADDRESS INFO -->
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">Street Address</h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-full">
        <b-field label="Address"
          :type="{'is-danger': $v.form.street_address.$error}"
          :message="{'Street Address is required': $v.form.street_address.$error}"
          v-bind:class="{ 'is-danger': $v.form.street_address.$error }"
        >
          <b-input v-model="form.street_address" @blur="blurAddress" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-5-tablet is-6-desktop">
        <b-field label="City"
          :type="{'is-danger': $v.form.street_city.$error}"
          :message="{'City is required': $v.form.street_city.$error}"
          v-bind:class="{ 'is-danger': $v.form.street_city.$error }"
        >
          <b-input v-model="form.street_city" @blur="blurCity" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-5-tablet is-3-desktop">
        <b-field label="State"
          :type="{'is-danger': $v.form.street_state.$error}"
          :message="{'State is required': $v.form.street_state.$error}"
          v-bind:class="{ 'is-danger': $v.form.street_state.$error }"
        >
          <b-autocomplete
            v-model="form.street_state"
            :data="filteredStreetStateArray"
            :readonly="readOnly"
            placeholder="e.g. Oregon"
            :keep-first="true"
            :open-on-focus="true"
            @input="blurState"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-2-tablet is-3-desktop">
        <b-field label="Zip"
          :type="{'is-danger': $v.form.street_zip.$error}"
          :message="{'Postal Code is required': !$v.form.street_zip.zip,
            'Postal Code should be blank': !$v.form.street_zip.notApplicable
          }"
          v-bind:class="{ 'is-danger': $v.form.street_zip.$error }"
        >
          <b-input v-model="form.street_zip" @blur="blurZip" :readonly="readOnly"></b-input>
        </b-field>
      </div>
    </div>

    <!-- MAILING ADDRESS INFO -->
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">Mailing Address</h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-full">
        <b-switch v-model="same" type="is-success" @input="flipAddressBlock" :disabled="readOnly">
          {{ isSame }}
        </b-switch>
      </div>
      <div class="column is-full" v-if="!same">
        <b-field label="Address"
          :type="{'is-danger': $v.form.mailing_address.$error}"
          :message="{'Street Address is required': $v.form.mailing_address.$error}"
          v-bind:class="{ 'is-danger': $v.form.mailing_address.$error }"
        >
          <b-input v-model="form.mailing_address" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-5-tablet is-6-desktop" v-if="!same">
        <b-field label="City"
          :type="{'is-danger': $v.form.mailing_city.$error}"
          :message="{'Street Address is required': $v.form.mailing_city.$error}"
          v-bind:class="{ 'is-danger': $v.form.mailing_city.$error }"
        >
          <b-input v-model="form.mailing_city" :readonly="readOnly"></b-input>
        </b-field>
      </div>
      <div class="column is-5-tablet is-3-desktop" v-if="!same">
        <b-field label="State"
          :type="{'is-danger': $v.form.mailing_state.$error}"
          :message="{'Street Address is required': $v.form.mailing_state.$error}"
          v-bind:class="{ 'is-danger': $v.form.mailing_state.$error }"
        >
          <b-autocomplete
            v-model="form.mailing_state"
            :data="filteredMailingStateArray"
            :readonly="readOnly"
            placeholder="e.g. Oregon"
            :keep-first="true"
            :open-on-focus="true"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-2-tablet is-3-desktop" v-if="!same">
        <b-field label="Zip"
          :type="{'is-danger': $v.form.mailing_zip.$error}"
          :message="{'Postal Code is required': !$v.form.mailing_zip.zip,
            'Postal Code should be blank': !$v.form.mailing_zip.notApplicable
          }"
          v-bind:class="{ 'is-danger': $v.form.mailing_zip.$error }"
        >
          <b-input v-model="form.mailing_zip" @blur="blurZip" :readonly="readOnly"></b-input>
        </b-field>
      </div>
    </div>

    <!-- BOAT INFO -->
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">Boat Information</h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Hull Serial Number"
          :type="{'is-danger': $v.form.hull_serial_number.$error}"
          :message="{'Hull number is required': $v.form.hull_serial_number.$error}"
          v-bind:class="{ 'is-danger': $v.form.hull_serial_number.$error }"
        >
            <b-select placeholder="Select Hull Number"
              expanded
              @input="hullChanged"
              v-model="form.hull_serial_number"
            >
                <option
                    v-for="option in oprHulls"
                    :value="option"
                    :key="option.label">
                    {{ option.label }}
                </option>
            </b-select>
        </b-field>
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Model">
          <b-input v-model="form.model" readonly></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Date of Purchase Deposit"
          :type="{'is-danger': $v.other.date_deposit.$error}"
          :message="{'Purchase date is required': $v.other.date_deposit.$error}"
          v-bind:class="{ 'is-danger': $v.other.date_deposit.$error }"
        >
          <span v-if="readOnly">
            <b-input v-model="other.date_deposit" readonly></b-input>
          </span>
          <span v-else>
            <b-datepicker
              is-info
              v-model="other.date_deposit"
              :date-formatter="dateFormatter"
              :min-date="date_deposit_start"
              :max-date="date_deposit_end"
              placeholder="Type or select a date..."
              icon="calendar-today"
              @input="changeDepositDate"
              >
            </b-datepicker>
          </span>
        </b-field>
      </div>
      <div class="column is-6-tablet is-3-desktop">
        <b-field label="Date of Final Delivery"
          :type="{'is-danger': $v.other.date_delivered.$error}"
          :message="{'Purchase date is required': $v.other.date_delivered.$error}"
          v-bind:class="{ 'is-danger': $v.other.date_delivered.$error }"
        >
          <span v-if="readOnly">
            <b-input v-model="other.date_delivered" readonly></b-input>
          </span>
          <span v-else>
            <b-datepicker
              is-info
              v-model="other.date_delivered"
              :date-formatter="dateFormatter"
              :min-date="date_delivered_start"
              :max-date="date_delivered_end"
              placeholder="Type or select a date..."
              icon="calendar-today"
              @input="changeDeliveredDate"
              >
            </b-datepicker>
          </span>
        </b-field>
      </div>
      <div class="column is-6-tablet is-5-desktop">
        <b-field label="Dealership">
          <b-input v-model="form.dealership" readonly></b-input>
        </b-field>
      </div>
      <div class="column is-6-tablet is-7-desktop">
        <b-field
          label="Salesperson"
          :type="{'is-danger': $v.form.salesperson.$error}"
          :message="{'Salesperson is required': $v.form.salesperson.$error}"
          v-bind:class="{ 'is-danger': $v.form.salesperson.$error }"
        >
          <b-input v-model="form.salesperson"></b-input>
        </b-field>
      </div>
</div>

    <!-- TRAILER INFO -->
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">Trailer Information</h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-5-tablet is-3-desktop">
        <b-field label="Trailer Model"
          :type="{'is-danger': $v.form.trailer_model.$error}"
          :message="{'Trailer Model is required': $v.form.trailer_model.$error}"
          v-bind:class="{ 'is-danger': $v.form.trailer_model.$error }"
        >
          <b-autocomplete
            v-model="form.trailer_model"
            :data="filteredTrailerListArray"
            placeholder="e.g. EZ Loader 3100"
            :keep-first="true"
            :open-on-focus="true"
            @blur="trailerBlurEvent"
            @select="trailerChanged"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-7-tablet is-9-desktop">
        <b-field label="Trailer Serial"
          :type="{'is-danger': $v.form.trailer_serial_number.$error}"
          :message="{'Trailer Serial Number is required': $v.form.trailer_serial_number.$error}"
          v-bind:class="{ 'is-danger': $v.form.trailer_serial_number.$error }"
        >
          <b-input v-model="form.trailer_serial_number"></b-input>
        </b-field>
      </div>
    </div>

    <!-- Motor INFO -->
    <div class="columns is-multiline">
      <div class="column is-full formgroup">
        <h3 class="title">Motor Information</h3>
        <hr class="has-background-white">
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 1 Make"
          :type="{'is-danger': $v.form.engine_1_make.$error}"
          :message="{'Make is required': $v.form.engine_1_make.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_1_make.$error }"
        >
          <b-autocomplete
            v-model="form.engine_1_make"
            :data="filteredEngine1MakeListArray"
            placeholder="e.g. Yamaha"
            :keep-first="true"
            :open-on-focus="true"
            @blur="engine1MakeBlurEvent"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 1 Model"
          :type="{'is-danger': $v.form.engine_1_model.$error}"
          :message="{'Engine Model is required': $v.form.engine_1_model.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_1_model.$error }"
        >
          <b-input v-model="form.engine_1_model"></b-input>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 1 Serial Number"
          :type="{'is-danger': $v.form.engine_1_serial_number.$error}"
          :message="{'Engine Serial Number is required': $v.form.engine_1_serial_number.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_1_serial_number.$error }"
        >
          <b-input v-model="form.engine_1_serial_number"></b-input>
        </b-field>
      </div>

      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 2 Make"
          :type="{'is-danger': $v.form.engine_2_make.$error}"
          :message="{'Make is required': $v.form.engine_2_make.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_2_make.$error }"
        >
          <b-autocomplete
            v-model="form.engine_2_make"
            :data="filteredEngine2MakeListArray"
            placeholder="e.g. Yamaha"
            :keep-first="true"
            :open-on-focus="true"
            @blur="engine2MakeBlurEvent"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 2 Model"
          :type="{'is-danger': $v.form.engine_2_model.$error}"
          :message="{'Engine Model is required': $v.form.engine_2_model.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_2_model.$error }"
        >
          <b-input v-model="form.engine_2_model"></b-input>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 2 Serial Number"
          :type="{'is-danger': $v.form.engine_2_serial_number.$error}"
          :message="{'Engine Serial Number is required': $v.form.engine_2_serial_number.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_2_serial_number.$error }"
        >
          <b-input v-model="form.engine_2_serial_number"></b-input>
        </b-field>
      </div>

      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 3 Make"
          :type="{'is-danger': $v.form.engine_3_make.$error}"
          :message="{'Make is required': $v.form.engine_3_make.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_3_make.$error }"
        >
          <b-autocomplete
            v-model="form.engine_3_make"
            :data="filteredEngine3MakeListArray"
            placeholder="e.g. Yamaha"
            :keep-first="true"
            :open-on-focus="true"
            @blur="engine3MakeBlurEvent"
            >
            <template slot="empty">No results found</template>
          </b-autocomplete>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 3 Model"
          :type="{'is-danger': $v.form.engine_3_model.$error}"
          :message="{'Engine Model is required': $v.form.engine_3_model.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_3_model.$error }"
        >
          <b-input v-model="form.engine_3_model"></b-input>
        </b-field>
      </div>
      <div class="column is-4-tablet is-4-desktop">
        <b-field label="Engine 3 Serial Number"
          :type="{'is-danger': $v.form.engine_3_serial_number.$error}"
          :message="{'Engine Serial Number is required': $v.form.engine_3_serial_number.$error}"
          v-bind:class="{ 'is-danger': $v.form.engine_3_serial_number.$error }"
        >
          <b-input v-model="form.engine_3_serial_number"></b-input>
        </b-field>
      </div>
    </div>

    <!-- BUTTONS -->
    <div class="columns is-multiline">
      <div class="column is-full">
      </div>
      <div class="column is-full has-text-right">
        <span v-if="readOnly">
          <b-button @click="$router.go(-1)" type="is-info">Back</b-button>
        </span>
        <span v-else>
          <b-button @click="$router.go(-1)" outlined>Cancel</b-button>
          <b-button @click="submitForm" type="is-dark" inverted :disabled="submit_locked">Submit</b-button>
        </span>
      </div>
      <div class="column is-full">
      </div>
    </div>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'
import { required, minLength, email, requiredIf, requiredUnless, or } from 'vuelidate/lib/validators'
import Cleave from 'cleave.js'
// require('cleave.js/dist/addons/cleave-phone.us.js')
import  GetCompany from '../components/GetCompany'
import  ConfirmDelete from '../components/ConfirmDelete'

const cleave = {
  name: 'cleave',
  bind (el, binding) {
    const input = el.querySelector('input')
    input._vCleave = new Cleave(input, binding.value)
  },
  unbind (el) {
    const input = el.querySelector('input')
    input._vCleave.destroy()
  }
}

// Validators
const atLeastNone = (value) => value.toLowerCase() === 'none' ||
  value.toLowerCase().split(' ').join('') === 'na' ||
  value.toLowerCase().split(' ').join('') === 'n/a' ||
  value.length > 8

export default {
  name: 'OPRform',
  directives: { cleave },
  data () {
    return {
      selected: null,
      name: '',
      id: '',
      dealership: 0,
      date_delivered_start: null,
      date_delivered_end: null,
      date_deposit_start: null,
      date_deposit_end: null,
      hull_serial_number: '',
      isFormValid: false,
      mailing_postal: false,
      same: true,
      submit_locked: false,
      street_postal: false,
      form: {
        // owner
        agency: '',
        contract: '',
        first_name: '',
        last_name: '',
        // contact
        phone_home: '',
        phone_work: '',
        email: '',
        // street address
        street_address: '',
        street_city: '',
        street_state: '',
        street_zip: '',
        // mailing address
        mailing_address: '',
        mailing_city: '',
        mailing_state: '',
        mailing_zip: '',
        // dealership
        salesperson: '',
        // purchased
        date_deposit: '',
        date_delivered: '',
        dealership: '',
        hull_serial_number: '',
        // trailer
        trailer_model: '',
        trailer_serial_number: '',
        // engines
        engine_1_make: '',
        engine_1_model: '',
        engine_1_serial_number: '',
        engine_2_make: '',
        engine_2_model: '',
        engine_2_serial_number: '',
        engine_3_make: '',
        engine_3_model: '',
        engine_3_serial_number: ''
      },
      other: {
        date_delivered: null,
        date_deposit: null
      },
      masks: {
        creditCard: {
          creditCard: true,
          delimiter: '-'
        },
        numeral: {
          numeral: true,
          numeralThousandsGroupStyle: 'thousand',
          prefix: '$ '
        },
        phoneNumber: {
          // phone: true,
          // phoneRegionCode: 'US'
          numericOnly: true,
          blocks: [0, 3, 3, 4],
          delimiters: ['(', ') ', '-']
        }
      }
    }
  },
  // ===========================================================================================================
  // ===========================================================================================================
  // VALIDATION SECTION
  validations: {
    form: {
      first_name: {
        required: required
      },
      last_name: {
        required: required
      },
      phone_home: {
        required: or(requiredUnless('phone_work'), requiredUnless('email')),
        minLength: minLength(14)
      },
      phone_work: {
        required: or(requiredUnless('phone_home'), requiredUnless('email')),
        minLength: minLength(14)
      },
      email: {
        required: or(requiredUnless('phone_home'), requiredUnless('phone_work')),
        email: email
      },
      street_address: {
        required
      },
      street_city: {
        required
      },
      street_state: {
        required
      },
      street_zip: {
        notApplicable (value) {
          if (this.form.street_state !== 'Not Applicable') {
            return true
          }
          return value.toString().length === 0
        },
        zip (value) {
          if (!this.form.street_state) {
            this.street_postal = false
            return false
          }
          if (this.form.street_state === 'Not Applicable') {
            this.street_postal = true
            return true
          }
        if (this.form.street_state.match(
              'British Columbia|Manitoba|New Brunswick|Newfoundland and Labrador|Nova Scotia|' +
              'Northwest Territories|Nunavut|Ontario|Prince Edward Island|Quebec|Saskatchewan|Yukon')) {
            let ca = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/
            this.street_postal = ca.test(value)
            return ca.test(value)
          }
          let us = /(^\d{5}$)|(^\d{5}-\d{4}$)/
          this.street_postal = us.test(value)
          return us.test(value)
        }
      },
      mailing_address: {
        required: requiredIf(function () {
          return !this.same
        })
      },
      mailing_city: {
        required: requiredIf(function () {
          return !this.same
        })
      },
      mailing_state: {
        required: requiredIf(function () {
          return !this.same
        })
      },
      mailing_zip: {
        notApplicable (value) {
          if (this.form.street_state !== 'Not Applicable') {
            return true
          }
          return value.toString().length === 0
        },
        zip (value) {
          if (!this.form.street_state) {
            return false
          }
          if (this.form.street_state === 'Not Applicable') {
            return true
          }
        if (this.form.street_state.match(
            'British Columbia|Manitoba|New Brunswick|Newfoundland and Labrador|Nova Scotia|' +
            'Northwest Territories|Nunavut|Ontario|Prince Edward Island|Quebec|Saskatchewan|Yukon')) {
            let ca = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/
            return ca.test(value)
          }
          let us = /(^\d{5}$)|(^\d{5}-\d{4}$)/
          return us.test(value)
        }
      },
      hull_serial_number: {
        required
      },
      salesperson: {
        required
      },
      trailer_model: {
        required
      },
      trailer_serial_number: {
        atLeastNone
      },
      engine_1_make: {
        required (v) {
          if (v) {
            return true
          }
          return !(this.form.engine_1_model || this.form.engine_1_serial_number)
        }
      },
      engine_1_model: {
        required: requiredIf('engine_1_make')
      },
      engine_1_serial_number: {
        required: requiredIf('engine_1_make')
      },
      engine_2_make: {
        required (v) {
          if (v) {
            return true
          }
          return !(this.form.engine_2_model || this.form.engine_2_serial_number)
        }
      },
      engine_2_model: {
        required: requiredIf('engine_2_make')
      },
      engine_2_serial_number: {
        required: requiredIf('engine_2_make')
      },
      engine_3_make: {
        required (v) {
          if (v) {
            return true
          }
          return !(this.form.engine_3_model || this.form.engine_3_serial_number)
        }
      },
      engine_3_model: {
        required: requiredIf('engine_3_make')
      },
      engine_3_serial_number: {
        required: requiredIf('engine_3_make')
      }
    },
    other: {
      date_delivered: {
        required
      },
      date_deposit: {
        required
      }
    }
  },
  // ===========================================================================================================
  // ===========================================================================================================
  // COMPUTED SECTION
  computed: {
    ...mapGetters([
      'debug',
      'engineMakeList',
      'fileName',
      'isNRB',
      'oprHulls',
      'oprs',
      'stateList',
      'trailerList',
      'userInfo'
    ]),
    readOnly () {
      return !!this.id
    },
    notReadOnly () {
      return !this.id
    },
    isSame () {
      return this.same ? 'Addresses are the Same' : 'Addresses are Different'
    },
    filteredHullsArray () {
      return this.oprHulls.filter((option) => {
        return option.id
          .toString()
          .replace(/\s+/g, '')
          .toLowerCase()
          .indexOf(this.form.hull_serial_number.toLowerCase().replace(/\s+/g, '')) >= 0
      })
    },
    filteredTrailerListArray () {
      return this.trailerList.filter((option) => {
        return option
          .toString()
          .replace(/\s+/g, '')
          .toLowerCase()
          .indexOf(this.form.trailer_model.toLowerCase().replace(/\s+/g, '')) >= 0
      })
    },
    filteredStreetStateArray () {
      return this.stateList.filter((option) => {
        return option
          .toString()
          .toLowerCase()
          .indexOf(this.form.street_state.toLowerCase()) >= 0
      })
    },
    filteredMailingStateArray () {
      return this.stateList.filter((option) => {
        return option
          .toString()
          .toLowerCase()
          .indexOf(this.form.mailing_state.toLowerCase()) >= 0
      })
    },
    filteredEngine1MakeListArray () {
      return this.engineMakeList.filter((option) => {
        return option
          .toString()
          .toLowerCase()
          .indexOf(this.form.engine_1_make.toLowerCase()) >= 0
      })
    },
    filteredEngine2MakeListArray () {
      return this.engineMakeList.filter((option) => {
        return option
          .toString()
          .toLowerCase()
          .indexOf(this.form.engine_2_make.toLowerCase()) >= 0
      })
    },
    filteredEngine3MakeListArray () {
      return this.engineMakeList.filter((option) => {
        return option
          .toString()
          .toLowerCase()
          .indexOf(this.form.engine_3_make.toLowerCase()) >= 0
      })
    }
  },
  // ===========================================================================================================
  // ===========================================================================================================
  // METHODS SECTION
  methods: {
    trailerBlurEvent: function (e) {
      if (this.lodash.findIndex(this.$store.state.trailerList, ['id', e.target.value]) === -1) {
        this.form.trailer_model = ''
      }
    },
    hullBlurEvent: function (e) {
      if (this.lodash.findIndex(this.$store.state.oprHulls, ['id', e.target.value]) === -1) {
        this.form.hull_serial_number = ''
      }
    },
    engine1MakeBlurEvent: function (e) {
      if (this.lodash.findIndex(this.$store.state.engineMakeList, ['id', e.target.value]) === -1) {
        this.form.engine_1_make = ''
      }
    },
    engine2MakeBlurEvent: function (e) {
      if (this.lodash.findIndex(this.$store.state.engineMakeList, ['id', e.target.value]) === -1) {
        this.form.engine_2_make = ''
      }
    },
    engine3MakeBlurEvent: function (e) {
      if (this.lodash.findIndex(this.$store.state.engineMakeList, ['id', e.target.value]) === -1) {
        this.form.engine_3_make = ''
      }
    },
    showCompany: function () {
      this.$buefy.modal.open({
        parent: this,
        component: GetCompany,
        hasModalCard: true,
        customClass: 'custom-class custom-class-2',
        events: {
          'pushCompany': value => {
            this.form.agency = value
          },
          'bye': value => {
            this.$router.go(value)
          }
        },
        canCancel: false,
        trapFocus: true,
      })
    },
    toDelete: function (id) {
      this.$buefy.modal.open({
        parent: this,
        component: ConfirmDelete,
        hasModalCard: true,
        customClass: 'custom-class custom-class-2',
        props: {
          hull: 'OPR ' + this.form.hull_serial_number,
          id: id,
        },
        events: {
          'doDelete': value => {
            console.log('deliting: ' + value)
            this.$store.dispatch('oprsDelete', id)
              .then(() => {
                this.$router.go(-1)
              })
          },
          'bye': value => {
            this.$router.go(value)
          }
        },
        canCancel: false,
        trapFocus: true,
      })
    },
    toPDF: function (id) {
      this.$store.dispatch('readOPRPDF', id)
        .then(() => {
          window.open(this.fileName, '_blank')
        })
    },
    dateFormatter (date) {
      if (date) {
        return this.$moment(date).format('MM/DD/YYYY')
      }
      return ''
    },
      setDateRanges(hull) {
          console.log(hull)
      // get build_year as "20" + model_year_decade and handle corner case for I920 = 2019 not 2029
      // this.$moment() expects yyyy-m-d or yyyy-mm-dd for input
      var buildYear = ''
      if (hull.charAt(11) === '9' & hull.charAt(13) === '0') {
        buildYear = '20' + (hull.charAt(12) - 1) + hull.charAt(11)
      } else {
        buildYear = '20' + hull.charAt(12) + hull.charAt(11)
      }
      var buildMonth = ('0' + (hull.charCodeAt(10) - 64)).slice(-2)
      var buildDay = '01'
      var buildDate = buildYear + '-' + buildMonth + '-' + buildDay

      this.date_deposit_start = this.$moment(buildDate).subtract(12, 'months').toDate()
      this.date_deposit_end = this.$moment(new Date()).toDate()
      // Change from -1 to -6 months per Sara on ticket #127061
      this.date_delivered_start = this.$moment(buildDate).subtract(6, 'months').toDate()
      this.date_delivered_end = this.$moment(new Date()).toDate()

      console.log("Start: " + this.date_delivered_start + " | End: " + this.date_delivered_end)

    },
    changeDepositDate () {
      if (this.other.date_deposit) {
        this.form.date_deposit = this.$moment(this.other.date_deposit).format('YYYY-MM-DD')
      } else {
        this.form.date_deposit = ''
      }
    },
    changeDeliveredDate () {
      if (this.other.date_delivered) {
        this.form.date_delivered = this.$moment(this.other.date_delivered).format('YYYY-MM-DD')
      } else {
        this.form.date_delivered = ''
      }
    },
    submitForm () {
      this.submit_locked = true
      this.$v.$touch()
      if (this.$v.$invalid) {
        this.formErrors()
        return
      }
      this.submit_locked = false
      const myid = this.form.hull_serial_number.id
      this.hull_serial_number = myid
      this.form.hull_serial_number = myid

      // fixup state
      const state1 = this.getState(this.form.street_zip.substring(0,5))
      const state2 = this.getState(this.form.mailing_zip.substring(0,5))
      if (state2) {
        this.form.mailing_state = state2
      }
      if (state1) {
        this.form.street_state = state1
      }
      
      let formData = new FormData()
      for (var key in this.form) {
        formData.append(key, this.form[key])
      }

      this.$store.dispatch('oprCreate', this.form)
        // eslint-disable-next-line
        .then(response => {
          // show notification that will last 2 seconds
          const notif = this.$buefy.notification.open({
            duration: 2000,
            message: 'Form has been saved',
            type: 'is-success'
          })
          // set timer to close window after 2 seconds
          notif.$on('close', () => {
            this.$router.go(-1)
          })
        })
    },
    formErrors () {
      this.$buefy.notification.open({
        duration: 2500,
        message: "There are errors on this form\nThey will be marked in red.",
        position: 'is-bottom',
        type: 'is-danger',
        hasIcon: true,
        closable: false
      })
      setTimeout(() => {
        this.submit_locked = false
      }, 2400)
    },
    // DROPDOWN FILTERS
    hullChanged (value) {
        console.log(value)
      if (value !== null) {
        this.form.dealership = value.dealership
        this.form.model = value.model
        this.form.date_deposit = ''
        this.other.date_deposit = null
        this.form.date_delivered = ''
        this.other.date_delivered = null
      } else {
        if (this.isNRB) { this.form.dealership = '' }
        this.form.model = ''
        this.form.date_deposit = ''
        this.other.date_deposit = null
        this.form.date_delivered = ''
        this.other.date_delivered = null
      }
      if (value !== null) {
        this.setDateRanges(value.id)
      }
    },
    flipAddressBlock: function () {
      if (this.same) {
        this.form.mailing_address = this.form.street_address
        this.form.mailing_city = this.form.street_city
        this.form.mailing_state = this.form.street_state
        this.form.mailing_zip = this.form.street_zip
      } else {
        this.form.mailing_address = ''
        this.form.mailing_city = ''
        this.form.mailing_state = ''
        this.form.mailing_zip = ''
      }
    },
    trailerChanged (value) {
      console.log(value)
    },
    // =========================================================================================================
    // Helper methods
    formatJson: function (field) {
      return JSON.stringify(field, undefined, 2)
    },
    blurAddress: function () {
      if (this.same) {
        this.form.mailing_address = this.form.street_address
      }
    },
    blurCity: function () {
      if (this.same) {
        this.form.mailing_city = this.form.street_city
      }
    },
    blurState: function () {
      if (this.same) {
        this.form.mailing_state = this.form.street_state
      }
    },
    blurZip: function () {
      console.log(`The Zip is ${this.street_postal ? 'valid' : 'invalid'}`)
      if (this.same) {
        this.form.mailing_zip = this.form.street_zip
      }
    },
    blurToggle: function () {
      if (this.same) {
        this.form.mailing_address = this.form.street_address
        this.form.mailing_city = this.form.street_city
        this.form.mailing_state = this.form.street_state
        this.form.mailing_zip = this.form.street_zip
      }
    },
    handleNone: function (value) {
      if (value.toLowerCase() === 'none' ||
      value.toLowerCase().split(' ').join('') === 'na' ||
      value.toLowerCase().split(' ').join('') === 'n/a') {
        return 'None'
      }
      return value
    },
    swapEngines: function (from, target) {
      var make = String(this.form['engine_' + from + '_make'])
      var model = String(this.form['engine_' + from + '_model'])
      var serial = String(this.form['engine_' + from + '_serial_number'])

      this.form['engine_' + target + '_make'] = make
      this.form['engine_' + target + '_model'] = model
      this.form['engine_' + target + '_serial_number'] = serial

      this.form['engine_' + from + '_make'] = ''
      this.form['engine_' + from + '_model'] = ''
      this.form['engine_' + from + '_serial_number'] = ''
    },
    cleanupEngines: function () {
      if (this.form.engine_3_make === null) {
        this.form.engine_3_make = ''
      }
      if (this.form.engine_2_make === null) {
        this.form.engine_2_make = ''
      }
      if (this.form.engine_1_make === null) {
        this.form.engine_1_make = ''
      }

      if (this.form.engine_2_make.length > 0 && this.form.engine_1_make.length === 0) {
        this.swapEngines('2', '1')
      }
      if (this.form.engine_3_make.length > 0 && this.form.engine_1_make.length === 0) {
        this.swapEngines('3', '1')
      }
      if (this.form.engine_3_make.length > 0 && this.form.engine_2_make.length === 0) {
        this.swapEngines('3', '2')
      }
    },
    getState(zipString) {
      /* Ensure param is a string to prevent unpredictable parsing results */
      if (typeof zipString !== 'string') {
          return
      }

      /* Ensure we have exactly 5 characters to parse */
      if (zipString.length !== 5) {
          return
      }

      /* Ensure we don't parse strings starting with 0 as octal values */
      const zipcode = parseInt(zipString, 10)

      var state

      /* Code cases alphabetized by state */
      if (zipcode >= 35000 && zipcode <= 36999) {
          // st = 'AL'
          state = 'Alabama'
      } else if (zipcode >= 99500 && zipcode <= 99999) {
          // st = 'AK'
          state = 'Alaska'
      } else if (zipcode >= 85000 && zipcode <= 86999) {
          // st = 'AZ'
          state = 'Arizona'
      } else if (zipcode >= 71600 && zipcode <= 72999) {
          // st = 'AR'
          state = 'Arkansas'
      } else if (zipcode >= 90000 && zipcode <= 96699) {
          // st = 'CA'
          state = 'California'
      } else if (zipcode >= 80000 && zipcode <= 81999) {
          // st = 'CO'
          state = 'Colorado'
      } else if ((zipcode >= 6000 && zipcode <= 6389) || (zipcode >= 6391 && zipcode <= 6999)) {
          // st = 'CT'
          state = 'Connecticut'
      } else if (zipcode >= 19700 && zipcode <= 19999) {
          // st = 'DE'
          state = 'Delaware'
      } else if (zipcode >= 32000 && zipcode <= 34999) {
          // st = 'FL'
          state = 'Florida'
      } else if ( (zipcode >= 30000 && zipcode <= 31999) || (zipcode >= 39800 && zipcode <= 39999) ) {
          // st = 'GA'
          state = 'Georgia'
      } else if (zipcode >= 96700 && zipcode <= 96999) {
          // st = 'HI'
          state = 'Hawaii'
      } else if (zipcode >= 83200 && zipcode <= 83999) {
          // st = 'ID'
          state = 'Idaho'
      } else if (zipcode >= 60000 && zipcode <= 62999) {
          // st = 'IL'
          state = 'Illinois'
      } else if (zipcode >= 46000 && zipcode <= 47999) {
          // st = 'IN'
          state = 'Indiana'
      } else if (zipcode >= 50000 && zipcode <= 52999) {
          // st = 'IA'
          state = 'Iowa'
      } else if (zipcode >= 66000 && zipcode <= 67999) {
          // st = 'KS'
          state = 'Kansas'
      } else if (zipcode >= 40000 && zipcode <= 42999) {
          // st = 'KY'
          state = 'Kentucky'
      } else if (zipcode >= 70000 && zipcode <= 71599) {
          // st = 'LA'
          state = 'Louisiana'
      } else if (zipcode >= 3900 && zipcode <= 4999) {
          // st = 'ME'
          state = 'Maine'
      } else if (zipcode >= 20600 && zipcode <= 21999) {
          // st = 'MD'
          state = 'Maryland'
      } else if ( (zipcode >= 1000 && zipcode <= 2799) || (zipcode == 5501) || (zipcode == 5544 ) ) {
          // st = 'MA'
          state = 'Massachusetts'
      } else if (zipcode >= 48000 && zipcode <= 49999) {
          // st = 'MI'
          state = 'Michigan'
      } else if (zipcode >= 55000 && zipcode <= 56899) {
          // st = 'MN'
          state = 'Minnesota'
      } else if (zipcode >= 38600 && zipcode <= 39999) {
          // st = 'MS'
          state = 'Mississippi'
      } else if (zipcode >= 63000 && zipcode <= 65999) {
          // st = 'MO'
          state = 'Missouri'
      } else if (zipcode >= 59000 && zipcode <= 59999) {
          // st = 'MT'
          state = 'Montana'
      } else if (zipcode >= 27000 && zipcode <= 28999) {
          // st = 'NC'
          state = 'North Carolina'
      } else if (zipcode >= 58000 && zipcode <= 58999) {
          // st = 'ND'
          state = 'North Dakota'
      } else if (zipcode >= 68000 && zipcode <= 69999) {
          // st = 'NE'
          state = 'Nebraska'
      } else if (zipcode >= 88900 && zipcode <= 89999) {
          // st = 'NV'
          state = 'Nevada'
      } else if (zipcode >= 3000 && zipcode <= 3899) {
          // st = 'NH'
          state = 'New Hampshire'
      } else if (zipcode >= 7000 && zipcode <= 8999) {
          // st = 'NJ'
          state = 'New Jersey'
      } else if (zipcode >= 87000 && zipcode <= 88499) {
          // st = 'NM'
          state = 'New Mexico'
      } else if ( (zipcode >= 10000 && zipcode <= 14999) || (zipcode == 6390) || (zipcode == 501) || (zipcode == 544) ) {
          // st = 'NY'
          state = 'New York'
      } else if (zipcode >= 43000 && zipcode <= 45999) {
          // st = 'OH'
          state = 'Ohio'
      } else if ((zipcode >= 73000 && zipcode <= 73199) || (zipcode >= 73400 && zipcode <= 74999) ) {
          // st = 'OK'
          state = 'Oklahoma'
      } else if (zipcode >= 97000 && zipcode <= 97999) {
          // st = 'OR'
          state = 'Oregon'
      } else if (zipcode >= 15000 && zipcode <= 19699) {
          // st = 'PA'
          state = 'Pennsylvania'
      } else if (zipcode >= 300 && zipcode <= 999) {
          // st = 'PR'
          state = 'Puerto Rico'
      } else if (zipcode >= 2800 && zipcode <= 2999) {
          // st = 'RI'
          state = 'Rhode Island'
      } else if (zipcode >= 29000 && zipcode <= 29999) {
          // st = 'SC'
          state = 'South Carolina'
      } else if (zipcode >= 57000 && zipcode <= 57999) {
          // st = 'SD'
          state = 'South Dakota'
      } else if (zipcode >= 37000 && zipcode <= 38599) {
          // st = 'TN'
          state = 'Tennessee'
      } else if ( (zipcode >= 75000 && zipcode <= 79999) || (zipcode >= 73301 && zipcode <= 73399) ||  (zipcode >= 88500 && zipcode <= 88599) ) {
          // st = 'TX'
          state = 'Texas'
      } else if (zipcode >= 84000 && zipcode <= 84999) {
          // st = 'UT'
          state = 'Utah'
      } else if (zipcode >= 5000 && zipcode <= 5999) {
          // st = 'VT'
          state = 'Vermont'
      } else if ( (zipcode >= 20100 && zipcode <= 20199) || (zipcode >= 22000 && zipcode <= 24699) || (zipcode == 20598) ) {
          // st = 'VA'
          state = 'Virginia'
      } else if ( (zipcode >= 20000 && zipcode <= 20099) || (zipcode >= 20200 && zipcode <= 20599) || (zipcode >= 56900 && zipcode <= 56999) ) {
          // st = 'DC'
          state = 'Washington DC'
      } else if (zipcode >= 98000 && zipcode <= 99499) {
          // st = 'WA'
          state = 'Washington'
      } else if (zipcode >= 24700 && zipcode <= 26999) {
          // st = 'WV'
          state = 'West Virginia'
      } else if (zipcode >= 53000 && zipcode <= 54999) {
          // st = 'WI'
          state = 'Wisconsin'
      } else if (zipcode >= 82000 && zipcode <= 83199) {
          // st = 'WY'
          state = 'Wyoming'
      } else {
          // st = 'none'
          state = 'none'
      }
      return state
    }
  },
  // =========================================================================================================
  created () {
    if (this.debug) { console.log('NAVIGATED TO: Original Purchaser Registration Form') }

    if (typeof (this.$route.params.id) !== 'undefined' && this.$route.params.id.toString() !== '0') {
      this.id = this.$route.params.id.toString()
      this.$store.dispatch('oprsRead', this.id)
        // eslint-disable-next-line
        .then(response => { 
          this.form = this.oprs.find(hull => hull.id === this.id)
          this.other.date_delivered = this.$moment(this.form.date_delivered).format('MM/DD/YYYY')
          this.other.date_deposit = this.$moment(this.form.date_deposit).format('MM/DD/YYYY')
        })
    } else {
			this.showCompany()
    }
    this.$store.dispatch('oprHullsRead')
    this.$store.dispatch('userInfoRead')
      // eslint-disable-next-line
      .then(response => {
        if (this.isNRB) {
          this.dealership = 'All Dealerships'
          this.form.dealership = ''
        } else {
          this.dealership = this.userInfo
          this.form.dealership = this.userInfo
        }
      })
  }
}
</script>

<style>
div.formgroup h3 {
  margin-bottom: 1rem !important;
}
.alignleft {
  float: left;
}
.alignright {
  float: right;
}
.required label::after {
  content: " *";
  color: red;
}
.is-danger label {
  color: red;
}
</style>
